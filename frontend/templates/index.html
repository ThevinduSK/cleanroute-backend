<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanRoute - Smart Waste Management</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-recycle"></i>
            <span class="logo-text">CLEAN<span class="highlight">ROUTE</span></span>
        </div>
        <nav class="nav-links">
            <a href="/" class="nav-link active"><i class="fas fa-map"></i> Map</a>
            <a href="/districts" class="nav-link"><i class="fas fa-city"></i> Districts</a>
            <a href="/iot" class="nav-link"><i class="fas fa-microchip"></i> IoT Dashboard</a>
        </nav>
        <div class="stats-bar">
            <div class="stat-item">
                <i class="fas fa-trash-alt"></i>
                <div class="stat-content">
                    <div class="stat-value" id="totalBins">--</div>
                    <div class="stat-label">Total Bins</div>
                </div>
            </div>
            <div class="stat-item">
                <i class="fas fa-check-circle"></i>
                <div class="stat-content">
                    <div class="stat-value" id="activeBins">--</div>
                    <div class="stat-label">Active</div>
                </div>
            </div>
            <div class="stat-item warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="stat-content">
                    <div class="stat-value" id="warningBins">--</div>
                    <div class="stat-label">Warning</div>
                </div>
            </div>
            <div class="stat-item danger">
                <i class="fas fa-exclamation-circle"></i>
                <div class="stat-content">
                    <div class="stat-value" id="fullBins">--</div>
                    <div class="stat-label">Critical</div>
                </div>
            </div>
            <div class="stat-item">
                <i class="fas fa-chart-pie"></i>
                <div class="stat-content">
                    <div class="stat-value" id="avgFill">--</div>
                    <div class="stat-label">Avg Fill</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="control-panel">
                <h2 class="panel-title">
                    <i class="fas fa-robot"></i> ML Prediction
                </h2>
                
                <div class="control-section">
                    <label class="control-label">
                        <i class="far fa-calendar-alt"></i> Prediction Date
                    </label>
                    <input type="date" id="predictionDate" class="control-input">
                </div>
                
                <div class="control-section">
                    <label class="control-label">
                        <i class="far fa-clock"></i> Prediction Time
                    </label>
                    <input type="time" id="predictionTime" class="control-input" value="14:00">
                </div>
                
                <button class="btn btn-primary" onclick="runPrediction()">
                    <i class="fas fa-brain"></i> Generate Predictions
                </button>
                
                <button class="btn btn-secondary" onclick="resetView()">
                    <i class="fas fa-sync-alt"></i> Reset View
                </button>
                
                <button class="btn btn-secondary" onclick="fitToAllBins()" style="margin-top: 10px;">
                    <i class="fas fa-expand-arrows-alt"></i> Fit All Bins
                </button>
                
                <a href="/districts" class="btn btn-secondary" style="text-decoration: none; display: block; text-align: center; margin-top: 10px;">
                    <i class="fas fa-map-marker-alt"></i> View by District
                </a>
            </div>

            <!-- Zone-Based Route Optimization -->
            <div class="control-panel" style="margin-top: 15px;">
                <h2 class="panel-title">
                    <i class="fas fa-route"></i> Zone Routing
                </h2>
                
                <div class="control-section">
                    <label class="control-label">
                        <i class="fas fa-city"></i> Select District
                    </label>
                    <select id="districtSelect" class="control-input" onchange="loadZonesForDistrict()">
                        <option value="">-- Select District --</option>
                    </select>
                </div>
                
                <div class="control-section">
                    <label class="control-label">
                        <i class="fas fa-map-marked-alt"></i> Select Zone
                    </label>
                    <select id="zoneSelect" class="control-input" onchange="showZoneOnMap()">
                        <option value="">-- Select Zone --</option>
                    </select>
                </div>
                
                <div class="control-section" id="depotInfo" style="display: none;">
                    <div style="background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                        <div style="color: #00ff88; font-size: 0.9rem;"><i class="fas fa-warehouse"></i> Starting Depot</div>
                        <div style="color: #fff; font-size: 0.85rem;" id="depotName">--</div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="optimizeZoneRoute()" id="optimizeZoneBtn" disabled>
                    <i class="fas fa-route"></i> Optimize Zone Route
                </button>
                
                <button class="btn btn-secondary" onclick="clearZoneSelection()" style="margin-top: 10px;">
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>

            <!-- Collection Day Workflow (Admin Only) -->
            <div class="control-panel" id="collectionDayPanel" style="margin-top: 15px; display: none;">
                <h2 class="panel-title">
                    <i class="fas fa-calendar-check"></i> Collection Day
                </h2>
                
                <div id="adminLoginSection">
                    <div class="control-section">
                        <label class="control-label">
                            <i class="fas fa-user-shield"></i> Admin Login
                        </label>
                        <input type="text" id="adminUsername" class="control-input" placeholder="Username" style="margin-bottom: 8px;">
                        <input type="password" id="adminPassword" class="control-input" placeholder="Password">
                    </div>
                    <button class="btn btn-primary" onclick="adminLogin()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
                
                <div id="collectionWorkflow" style="display: none;">
                    <div style="background: rgba(0,255,136,0.1); border: 1px solid #00ff88; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                        <div style="color: #00ff88; font-size: 0.8rem;">Logged in as:</div>
                        <div style="color: #fff; font-size: 0.9rem; font-weight: bold;" id="loggedInUser">admin</div>
                    </div>
                    
                    <div id="collectionStatus" style="display: none; margin-bottom: 15px;">
                        <div style="background: rgba(255,170,0,0.1); border: 1px solid #ffaa00; border-radius: 8px; padding: 10px;">
                            <div style="color: #ffaa00; font-size: 0.8rem;">Collection Status:</div>
                            <div style="color: #fff; font-size: 0.9rem;" id="collectionStatusText">Not Started</div>
                            <div style="color: #8892b0; font-size: 0.8rem; margin-top: 5px;">
                                <span id="binsRespondedText">0</span> / <span id="binsTotalText">0</span> bins responded
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-section" style="margin-bottom: 10px;">
                        <div style="color: #8892b0; font-size: 0.8rem; margin-bottom: 8px;">
                            <i class="fas fa-info-circle"></i> Select a zone above, then:
                        </div>
                    </div>
                    
                    <button class="btn" id="btnStartCollection" onclick="startCollection()" 
                            style="background: linear-gradient(135deg, #00ff88, #00cc6a); width: 100%; margin-bottom: 8px;" disabled>
                        <i class="fas fa-power-off"></i> 1. Start Collection (Wake Up)
                    </button>
                    
                    <button class="btn" id="btnCheckStatus" onclick="checkCollectionStatus()"
                            style="background: linear-gradient(135deg, #0088ff, #0066cc); width: 100%; margin-bottom: 8px;" disabled>
                        <i class="fas fa-sync"></i> 2. Check Status
                    </button>
                    
                    <button class="btn" id="btnFinishCollection" onclick="finishCollection()"
                            style="background: linear-gradient(135deg, #ffaa00, #ff8800); width: 100%; margin-bottom: 8px;" disabled>
                        <i class="fas fa-clipboard-check"></i> 3. Finish (Verify)
                    </button>
                    
                    <button class="btn" id="btnEndCollection" onclick="endCollection()"
                            style="background: linear-gradient(135deg, #ff0055, #cc0044); width: 100%;" disabled>
                        <i class="fas fa-moon"></i> 4. End Collection (Sleep)
                    </button>
                    
                    <button class="btn btn-secondary" onclick="adminLogout()" style="margin-top: 15px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- IoT Metrics Panel (Admin Only) -->
            <div class="control-panel" id="iotMetricsPanel" style="margin-top: 15px; display: none;">
                <h2 class="panel-title">
                    <i class="fas fa-microchip"></i> IoT Metrics
                </h2>
                
                <div id="iotMetricsContent">
                    <div style="color: #8892b0; font-size: 0.85rem; text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading metrics...
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="refreshIoTMetrics()" style="margin-top: 10px; width: 100%;">
                    <i class="fas fa-sync-alt"></i> Refresh Metrics
                </button>
            </div>

            <!-- Route Info -->
            <div class="route-info" id="routeInfo" style="display: none;">
                <h3 class="route-title">
                    <i class="fas fa-truck"></i> Route Details
                </h3>
                <div class="route-stats">
                    <div class="route-stat">
                        <span class="route-stat-label">Bins to Collect:</span>
                        <span class="route-stat-value" id="routeBinsCount">0</span>
                    </div>
                    <div class="route-stat">
                        <span class="route-stat-label">Total Distance:</span>
                        <span class="route-stat-value" id="routeDistance">0 km</span>
                    </div>
                    <div class="route-stat">
                        <span class="route-stat-label">Est. Time:</span>
                        <span class="route-stat-value" id="routeTime">0 hrs</span>
                    </div>
                </div>
                <div class="route-waypoints" id="routeWaypoints"></div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <h3 class="legend-title">
                    <i class="fas fa-info-circle"></i> Legend
                </h3>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #00ff88;"></span>
                    <span class="legend-label">Normal (&lt;70%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #ffaa00;"></span>
                    <span class="legend-label">Warning (70-90%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #ff0055;"></span>
                    <span class="legend-label">Critical (&gt;90%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-marker" style="background: #666;"></span>
                    <span class="legend-label">Offline</span>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <main class="map-container">
            <div id="map"></div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <p>Processing...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Bin Detail Modal -->
    <div class="modal" id="binModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Bin Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
